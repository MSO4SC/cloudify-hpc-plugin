stages:
  - test
  - package
#  - deploy

# Change pip's cache directory to be inside the project directory since we can
# only cache local items.
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Pip's cache doesn't store the python packages
# https://pip.pypa.io/en/stable/reference/pip_install/#caching
#
# If you want to also cache the installed packages, you have to install
# them in a virtualenv and cache it as well.
cache:
  paths:
    - .cache/pip

flake8_linter:
  stage: test
  image: python:2.7
  script:
  - pip install tox flake8  # you can also use tox
  - tox -e flake8

unittests:
  stage: test
  image: python:2.7
  script:
  - pip install tox
  - tox -e py27

create_wagon:
  stage: package
  image: centos:7
  dependencies:
  - $CI_COMMIT_REF_NAME
  script:
  - yum install -y -q zip
  - zip -r hpc_plugin.zip .
  - yum install -y -q epel-release
  - yum install -y -q python python-pip
  - pip install -q wagon==0.6.1
  - wagon create hpc_plugin.zip -a '--no-cache-dir -c constraints.txt'
  environment:
    name: $CI_COMMIT_REF_NAME
    url: http://portal.mso4sc.com
  artifacts:
    name: "$CI_COMMIT_REF_NAME-package"
    paths:
    - "*.wgn"
    expire_in: 1 hour
  only:
    - staging
    - canary
    - master
